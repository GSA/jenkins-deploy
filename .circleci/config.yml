version: 2
jobs:
  build:
    docker:
      - image: docker
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Start remote container
          command: |
            docker run \
              -it --privileged -d \
              --name remote \
              --volume /etc/jenkins-deploy --workdir /etc/jenkins-deploy/tests \
              geerlingguy/docker-centos7-ansible
      # https://circleci.com/docs/2.0/building-docker-images/#mounting-folders
      - run:
          name: Copy local files
          command: docker cp . remote:/etc/jenkins-deploy
      - run:
          name: Install Ansible roles
          command: |
            docker exec -it remote \
              ansible-galaxy install -r requirements.yml
      - run:
          name: Run Ansible playbook
          command: |
            docker exec -it remote \
              ansible-playbook test.yml
  validate_terraform:
    working_directory: /etc/jenkins-deploy
    docker:
      - image: hashicorp/terraform
    steps:
      - checkout
      - run:
          name: Install Make
          command: apk add --update make
      - run:
          name: Check Terraform syntax
          command: make validate_terraform
workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - validate_terraform
