machine:
  environment:
    # https://github.com/knakayama/terraform-circleci-demo/blob/6ef7901b4fdb5570553080e74d297415ee06745f/circle.yml
    TERRAFORM_VER: 0.9.8
    PATH: $PATH:$HOME/.local/bin:$HOME/bin
  services:
    - docker
dependencies:
  pre:
    # https://docs.ansible.com/ansible/intro_installation.html#latest-releases-via-apt-ubuntu
    - sudo apt-get install -y software-properties-common
    - sudo apt-add-repository -y ppa:ansible/ansible
    - sudo apt-get -y update
    - sudo apt-get install -y ansible
    - make install_roles
  override:
    - |
      if [[ ! -f ~/.local/bin/terraform ]]; then
        mkdir -p ~/.local/bin
        cd ~/.local/bin
        wget "https://releases.hashicorp.com/terraform/${TERRAFORM_VER}/terraform_${TERRAFORM_VER}_linux_amd64.zip"
        unzip *.zip
        rm *.zip
      fi
  cache_directories:
    - ~/.local/bin
    - tests/roles
test:
  override:
    # should correspond to test commands in Makefile
    - make validate_terraform
    - make validate_ansible
    - make test_ansible
